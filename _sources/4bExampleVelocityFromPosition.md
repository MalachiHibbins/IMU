# Velocity from position
This example looks at applying a kalman filter to fit noisy postion data as well as outputting a prediction of the velocity. It turns out the output from the kalman filter is much more accurate than using numerical differentiation on the noisy signal.
```{figure} image-27.png
:label: Classic-Kalman
Diagram of a kalman filter.
```
In this case $\hat{x}$ is a vector containing position $s$ and velocity $v$ and $\hat{z}$ is the scalar $s$. The measurment and the state are related by $\hat{z}_{k+1} = H\hat{x}_k$ it follows:
```{math}
:label: H
z = \begin{bmatrix} 1 & 0 \end{bmatrix} \begin{bmatrix} s_k \\ v_k \end{bmatrix}
```
For the prediction assume no accelation the equation of motion is:
```{math}
:label: velocity
\begin{bmatrix} s_{k+1} \\ v_{k+1} \end{bmatrix} = \begin{bmatrix} s_k + v_k \Delta t \\ v_k \end{bmatrix} = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix} \begin{bmatrix} s_k \\ v_k \end{bmatrix}
```
which is in the form $\hat{x}_{k+1} = A\hat{x}_k$.

So:
- $x_k = \begin{bmatrix} s \\ v \end{bmatrix}_k$
- $z_k = s_k$
- $A = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix}$
- $Q = \begin{bmatrix} Q_s & 0 \\ 0 & Q_v\end{bmatrix}$ 
```{note}
While Q isn't necessarily a diagonal matrix its easier to visualise the ajustments of the two parameters in the diagonal compared to adjusting all the parameters. 
```
- $R$ is one dimensional and is obtained by tuning.
- $x_0 = 0$ and $P_0 = \begin{bmatrix} P_s & 0 \\ 0 & P_v\end{bmatrix}$

```{important}
The true signal in the graphs below is generated using a combination of $\sin$ waves of varing amplitudes and speeds, the velocity version is the analytical deriative of this. The noisy signal is generated by adding randomly generated values to this using the guassian distribution. The kalman filter is applied to the noisy position data and outputs the filtred postion data and filtered velocity data. Which are graphed below
```


The summary statistics are generated between the true signal and the kalman filtered signal. $\mu^2$ refers to the random mean squared error and $\mu$ refers to the mean absolute error.

```{figure} image-23.png
:name: original
Kaman filter setup using parameters above to fit a noisy signal made up from sin waves with varing amplitudes and periods.
```
The fit for the position is very good with high R$^2$ value. However it could be smoother and the residules graph is not completely random suggesting there could be some delay, prehaps increasing $R$ would improve the fit. The velocity fit is poor and the filtered signal lags behind the true signal. Since only the velocity signal is lagging Q_v was increased.

```{figure} image-24.png
:name: increased-R-and-increased-Q
{numref}`original` with increased R and increased Q
```

Figure {numref}`increased-R-and-increased-Q` shows a slightly improved fit with position and a significantly improved fit with velocity. However the velocity fit is now significantly less smooth, there is a clear tradeoff between having a a smooth fit and having an accurate fit. Smoother fits more accurately represent the true shape of the data, but will often cause there to be a delay. The residuals graph for position now seems to be very random implying close to optimal fit, the residuals graph for velocity is close to being random.

```{admonition} Question
How is it possible to ensure both a smooth fit whilst minimising lag and ensuring a good fit? Prehaps a machine learning algorithm?
```

```{note}
Using a kalmamn filter for differentiation is significantly more accurate than performing numerical integration on the noisy signal. 
```

