# Battery output

This example looks at how a kalman filter can be used to fit a constant signal in this case the output from a battery. The aim of this simple example is to experiment with changing the parameters $A$, $H$, $Q$ and $R$.
- $\hat{x}$ is the voltage which is scalar, $n = 1$, 
- $\hat{z}$ is also the voltage, $m=1$
- So $A$, $H$, $Q$ and $R$ are scalars
- $A=1$ the battery output is constant so $x_{k+1}$ = $x_k$
- $Q = 0$ since the model predicts the battery output stays constant. In this case the noisy signal is generated by just adding gaussian noise to a fixed value so there is no error associated with this model. In reality the battery voltage may vary for reasons other than random variation, e.g. when running low output voltage will decay.
- $H = 1$ The measurement sensor directly observes the voltage
- $R$ is tuned
- $x_0$ was set to 5
- $P_0$ was set to 1

```{figure} image-2.png
:name: fig-kalman-constant
Kalman filter used to fit a non-varying signal with a large amount of noise.
```
{numref}`fig-kalman-constant` shows the rate of convergence is exponentially fast and much more smooth than the average filter.

```{figure} image-3.png
:name: fig-small-r
{numref}`fig-kalman-constant` but with smaller $R$.
```

{numref}`fig-small-r` shows smaller $R$ makes the rate of convergence faster but after 500 samples it is further from the mean than when $R=4$. This is because smaller $R$ means the kalman filter trusts measurments over the prediction.

```{figure} image-4.png
:name: fig-larger-r
{numref}`fig-kalman-constant` but with larger $R$.
```

{numref}`fig-larger-r` shows slower convergence than figures 4.1 and 4.2 but has the smoothest convergence of the three. {numref}`fig-kalman-constant` seems to be best as it has a good tradeoff between a noise free filtered signal and fast convergence.

```{figure} image-5.png
:name: figu-kalman-wrong-h
{numref}`fig-kalman-constant` with H set to $1.115$ rather than $1$
```

Varying H will lead to the kalman filter converging to the wrong value since the measurement directly measures the state only satisfied by $H = 1$.

```{figure} image-6.png
:name: fig-kalman-a-1004
{numref}`fig-kalman-constant` with $A$ set to 1.004 rather than 1.
```

This causes the kalman filter to diverge since only $A=1$ describes a straight line. It diverges quickly since $Q=0$ puts more weighting on $\hat{x}_k$ compared to $\hat{z_k}$.
```{figure} image-7.png
:name: fig-kalman-q-0817
{numref}`fig-kalman-constant` except with $Q = 0.817$ rather than 1.
```

Setting $Q$ to anything other than $0$ in this example makes the filtered signal noisy. Increasing $Q$ puts more trust $\hat{z}_k$ over $\hat{x}^-_{k}$ when predicting $\hat{x}_k$ which means the signal becomes noisy like the data. In this case $Q=0$ is allowed since we are assuming $w_k=0$ i.e. no noise in the prediction.

```{important}
$A$ and $H$ form the model of the system and changing these values will mean the filter won't work. $Q$ and $R$ are more difficult to determine and are often done by tuning. 
```