# Velocity from position
This example looks at applying a kalman filter to fit noisy postion data as well as outputting a prediction of the velocity. It turns out the output from the kalman filter is much more accurate than using numerical differentiation on the noisy signal.
```{figure} image-27.jpg
:label: Classic-Kalman
Diagram of a kalman filter.
```
## Model
In this case $\hat{x}$ is a vector containing position $s$ and velocity $v$ and $\hat{z}$ is the scalar $s$. The measurment and the state are related by $\hat{z}_{k+1} = H\hat{x}_k$ it follows:
```{math}
:label: H
z_k = s_k = \begin{bmatrix} 1 & 0 \end{bmatrix} \begin{bmatrix} s_k \\ v_k \end{bmatrix}
```
For the prediction assume no accelation the equation of motion is:
```{math}
:label: velocity
\begin{bmatrix} s_{k+1} \\ v_{k+1} \end{bmatrix} = \begin{bmatrix} s_k + v_k \Delta t \\ v_k \end{bmatrix} = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix} \begin{bmatrix} s_k \\ v_k \end{bmatrix}
```
which is in the form $\hat{x}_{k+1} = A\hat{x}_k$.

So:
- $x_k = \begin{bmatrix} s \\ v \end{bmatrix}_k$
- $z_k = s_k$
- $A = \begin{bmatrix} 1 & \Delta t \\ 0 & 1 \end{bmatrix}$
- $H = \begin{bmatrix} 1 & 0 \end{bmatrix}$ 
- $R$ is one dimensional and is obtained by tuning.
- $x_0 = 0$ and $P_0 = \begin{bmatrix} P_s & 0 \\ 0 & P_v\end{bmatrix}$

```{note}
While P_0 isn't necessarily a diagonal matrix its easier to visualise the ajustments of the two parameters in the diagonal compared to adjusting all the parameters. 
```

## Tuning
Q is going to be a $2 \times 2$ matrix which can be written as:

```{math}
Q = E[w_kw_k^T] =  \begin{bmatrix} VAR(s) & COV(s,v) \\ COV(v,s) & VAR(v) \end{bmatrix} = \sigma^2 \begin{bmatrix} \frac{\Delta t^4}{4} & \frac{\Delta t^3}{2} \\ \frac{\Delta t^3}{2} & \Delta t^2 \end{bmatrix}
```
{cite}`Barreto2021,chapter=2.3` {cite}`Barreto2021,chapter=10.2`
where $\sigma_a^2$ is the error in the accelaration, which is the model assumes is zero. $\sigma^2$ will be used as a tuning parameter.
$R$ is going to be the variance in the measurments. $R = \sigma_s$.
The tuning parameters in this simulation will be $\sigma_a$ and $\sigma_s$.

## Implementation


The true signal in the graphs below is generated using a combination of $\sin$ waves of varing amplitudes and speeds, the velocity version is the analytical deriative of this. The noisy signal is generated by adding randomly generated values to this using the guassian distribution. The kalman filter is applied to the noisy position data and outputs the filtred postion data and filtered velocity data. Which are graphed below.
The summary statistics are generated between the true signal and the kalman filtered signal. $\mu^2$ refers to the random mean squared error and $\mu$ refers to the mean absolute error.


```{figure} image-23.png
:name: fig-original
The measured noisy $s_k$, noise free $s_k$ and kalman filtered $s_k$ plotted against index and kalman filtered $v_k$ noise free $v_k$ and the differentiated kalman filtered $s_k$ against index.
```
The fit for the position is very good with high R$^2$ value. However it could be smoother and the residules graph is not completely random suggesting there could be some delay, prehaps increasing $R$ would improve the fit. The velocity fit is poor and the filtered signal lags behind the true signal. Since only the velocity signal is lagging $Q_v$ was increased.

```{figure} image-24.png
:name: fig-increased-R-and-increased-Q
See {numref}`fig-original` with increased $R$ and increased $Q_v$.
```

Figure {numref}`fig-increased-R-and-increased-Q` shows a slightly improved fit with position and a significantly improved fit with velocity. This makes sense for the postion data since increasing $R$ increases the weighting for the prediction compared to the measured data. However the velocity fit is now significantly less smooth since more emphasis is being put on the measured positions, there is a clear tradeoff between having a a smooth fit and having an accurate fit. Smoother fits more accurately represent the true shape of the data, but will often cause there to be a delay. The residuals graph for position now seems to be very random implying close to optimal fit, the residuals graph for velocity is close to being random. 

```{important}
 If the Kalman filter fit is too noisy, due to an over emhasis on $\hat{z}_k$ being used to calculate $\hat{x}_{k+1}$ increasing $R$ or decreasing $Q$ will make the fit smoother. If the kalman filter fit is delayed increasing $Q$ or decreasing $R$ will reduce the delay. Increasing $Q$ has essentially the same effect as decreasing $R$ and increasing $R$ has the same effect as decreasing $Q$. 
``` 

```{admonition} Question
How is it possible to ensure both a smooth fit whilst minimising lag and ensuring a good fit? Prehaps a machine learning algorithm?
```


The velocity fit is still quite poor. There is no measured velocity data so the velocity is calculated from the previous predictions of the position ($z^-_k$). Increasing and decreasing $Q_v$ adjusts how quickly the weighting of less recent results decays. Essentially the kalman filter is predicting the velocity data and then fitting this with a low pass filter. Which is why its still more accurate to get the velocity using the kalman filter then it is to differentiate the kalman filtered position signal. 

Here it's clear the differentiated kalman position is a poor fit as its too noisy, but the kalman filtered velocity fits like a low pass filter. **A kalman filter compares predicted values with measurments, which are weighted in a similar fasion to the low pass filter, to create an estimate of the true state measurments**. The fit for $v_k$ would be greatly improved using a second kalman filter which would use the velocity from this kalman filter as a prediction and compare it with real velocity data.