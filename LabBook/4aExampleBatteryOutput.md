# 3 Example: Battery output

This example looks at how a Kalman filter can be used to fit a constant signal in this case the output from a battery. The aim of this simple example is to experiment with changing the Kalman parameters $A$, $H$, $Q$, $R$, $\hat{x}_0$ and $P_0$.

## 3.1 Model
- $\hat{x}$ is the voltage since thats what we are estimating, $n = 1$, 
- $z$ is the voltage which is what we are measuring, $m=1$
In this very simple example $A$, $H$, $Q$ and $R$ are all scalars since $m=n=1$
- $A=1$ the battery output is constant which means $x_{k+1}$ = $x_k$ comparing with {eq}`projection` shows $A = 1$
- $Q = 0$ In this case the noisy signal is generated by just adding gaussian noise to a fixed value hence we would expect $w_k=0$ which means $Q=0$ from {eq}`eq-process-noise-cov` i.e. the model is perfect. In reality the battery voltage may vary for reasons other than random variation.
- $H = 1$ since estimate corresponds directly to measurement from {eq}`eq-h-calculate` we can evaluate $H$.
- $R = 4$ initially but was determined through tuning.
- $x_0$ was set to 5
- $P_0$ was set to 1

## 3.2 Testing
The code for this example can be found [here](https://github.com/MalachiHibbins/IMU/tree/main/4aSimpleKalman). The code is broken up into 3 files: `GenTestSig.py` which generates the true signal (a constant value) and adds gaussian noise to it; `SimpleKalman.py` contains the algorithm for the kalman filter for the 1D case; and `TestWidget.py` which plots the results, with a widget so you can edit the Kalman Parameters.
```{figure} image-2.png
:name: fig-kalman-constant
Kalman filter used to fit a non-varying signal with a large amount of noise.
```
{numref}`fig-kalman-constant` shows the rate of convergence is exponentially fast and much more smooth than the average filter. This makes sence as the prediction phase means of the Kalman filter makes it less susceptible to noise.

```{figure} image-3.png
:name: fig-small-r
{numref}`fig-kalman-constant` but with smaller $R$.
```

{numref}`fig-small-r` shows smaller $R$ makes the rate of convergence faster but after 500 samples it is further from the mean than when $R=4$. This is because smaller $R$ means the Kalman filter trusts measurements over the prediction.

```{figure} image-4.png
:name: fig-larger-r
{numref}`fig-kalman-constant` but with larger $R$.
```

{numref}`fig-larger-r` shows slower convergence than figures 4.1 and 4.2 but has the smoothest convergence of the three. {numref}`fig-kalman-constant` seems to be best as it has a good tradeoff between a noise free filtered signal and fast convergence.

```{figure} image-5.png
:name: figu-kalman-wrong-h
{numref}`fig-kalman-constant` with H set to $1.115$ rather than $1$
```

Varying H will lead to the Kalman filter converging to the wrong value since the measurement directly measures the state only satisfied by $H = 1$.

```{figure} image-6.png
:name: fig-kalman-a-1004
{numref}`fig-kalman-constant` with $A$ set to 1.004 rather than 1.
```

This causes the Kalman filter to diverge since only $A=1$ describes a straight line. It diverges quickly since $Q=0$ puts more weighting on $\hat{x}_k$ compared to $\hat{z_k}$.
```{figure} image-7.png
:name: fig-kalman-q-0817
{numref}`fig-kalman-constant` except with $Q = 0.817$ rather than 1.
```

Setting $Q$ to anything other than $0$ in this example makes the filtered signal noisy. Increasing $Q$ puts more trust $\hat{z}_k$ over $\hat{x}^-_{k}$ when predicting $\hat{x}_k$ which means the signal becomes noisy like the data. In this case $Q=0$ is allowed since we are assuming $w_k=0$ i.e. no noise in the prediction.

```{important}
$A$ and $H$ form the model of the system and changing these values will mean the filter won't work. $Q$ and $R$ are more difficult to determine and are often done by tuning. 
``` 